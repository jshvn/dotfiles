version: '3'

# =============================================================================
# Unified Profile Tasks
# =============================================================================
# This file is included once per profile with the
# TARGET_PROFILE variable set. Tasks are parameterized to work with any profile.
#
# Usage in Taskfile.yml:
#   includes:
#     personal:
#       taskfile: ./taskfiles/profile-tasks.yml
#       vars:
#         TARGET_PROFILE: personal
# =============================================================================

includes:
  _: ./helpers.yml

tasks:
  # ============================================================================
  # Installation
  # ============================================================================

  install:
    desc: "Install {{.TARGET_PROFILE}} profile configurations"
    cmds:
      - |
        source "$DOTFILES_MESSAGES"
        info "Installing {{.TARGET_PROFILE}} profile..."
      - task: links
      - task: brew
      - |
        source "$DOTFILES_MESSAGES"
        success "{{.TARGET_PROFILE}} profile configured"

  links:
    desc: "Create {{.TARGET_PROFILE}}-specific symlinks"
    cmds:
      # Git profile config
      - task: _:safe-link
        vars:
          SOURCE: "{{.DOTFILEDIR}}/git/config-{{.TARGET_PROFILE}}"
          TARGET: "{{.XDG_CONFIG_HOME}}/git/config-{{.TARGET_PROFILE}}"
      
      # SSH profile config
      - task: _:safe-link
        vars:
          SOURCE: "{{.DOTFILEDIR}}/ssh/configs/config-{{.TARGET_PROFILE}}"
          TARGET: "{{.HOME}}/.ssh/config-{{.TARGET_PROFILE}}"
      
      # SSH public key (if it exists for this profile)
      - cmd: |
          KEY_FILE="{{.DOTFILEDIR}}/ssh/keys/id_ed25519_{{.TARGET_PROFILE}}.pub"
          if [[ -f "$KEY_FILE" ]]; then
            mkdir -p "{{.HOME}}/.ssh"
            ln -sf "$KEY_FILE" "{{.HOME}}/.ssh/id_ed25519_{{.TARGET_PROFILE}}.pub"
          fi
    status:
      - test -L "{{.XDG_CONFIG_HOME}}/git/config-{{.TARGET_PROFILE}}"
      - test -L "{{.HOME}}/.ssh/config-{{.TARGET_PROFILE}}"

  brew:
    desc: "Install {{.TARGET_PROFILE}}-specific Homebrew packages"
    cmds:
      - |
        {{.BREW_SHELLENV}}
        BREWFILE="{{.DOTFILEDIR}}/install/Brewfile-{{.TARGET_PROFILE}}.rb"
        if [[ -f "$BREWFILE" ]]; then
          brew bundle --file "$BREWFILE"
        fi

  # ============================================================================
  # Validation
  # ============================================================================

  validate:
    desc: "Validate {{.TARGET_PROFILE}} profile symlinks"
    cmds:
      - task: _:check-link
        vars:
          TARGET: "{{.XDG_CONFIG_HOME}}/git/config-{{.TARGET_PROFILE}}"
          NAME: "git config-{{.TARGET_PROFILE}}"
      - task: _:check-link
        vars:
          TARGET: "{{.HOME}}/.ssh/config-{{.TARGET_PROFILE}}"
          NAME: "ssh config-{{.TARGET_PROFILE}}"
      # Check SSH key only if it exists in source
      - cmd: |
          KEY_SOURCE="{{.DOTFILEDIR}}/ssh/keys/id_ed25519_{{.TARGET_PROFILE}}.pub"
          KEY_TARGET="{{.HOME}}/.ssh/id_ed25519_{{.TARGET_PROFILE}}.pub"
          if [[ -f "$KEY_SOURCE" ]]; then
            source "$DOTFILES_MESSAGES"
            if [[ -L "$KEY_TARGET" ]]; then
              check "ssh {{.TARGET_PROFILE}} public key"
            else
              cross "ssh {{.TARGET_PROFILE}} public key"
            fi
          fi
